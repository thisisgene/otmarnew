var express=require("express"),router=express.Router(),marked=require("marked"),mongoose=require("mongoose"),Project=mongoose.model("Project");router.get("/",function(e,o,r){Project.find(function(e,r){o.render("admin/index",{title:"Admin",projects:r})})}),router.post("/create_project",function(e,o){var r=e.body.name;console.log(r),new Project({name:r,deleted:!1}).save(function(e,r){e||o.send(r._id)})}),router.post("/create_sub_project",function(e,o){var r=e.body.name,n=e.body.parentId;Project.findById(n,function(e,t){if(e)console.log(e);else{var d=new Project({name:r,deleted:!1,hasParent:!0,parentId:n,parentName:t.name});d.save(),console.log(t),t.children.push(d._id),t.hasChildren=!0,t.save(function(e,r){o.send("success")})}})}),router.get("/delete/:id",function(e,o){var r=e.params.id;Project.findById(r,function(e,r){r.deleted=!0,r.save(function(e,r){o.redirect("/admin")})})}),router.get("/project/:id",function(e,o,r){Project.find(function(r,n){o.render("admin/index",{title:"Admin",projects:n,currentProjectId:e.params.id})})}),router.post("/save_all",function(e,o){var r=e.body,n=r.id,t=r.description,d=marked(t),c=r.layout;Project.findById(n,function(e,r){r.descMU=t,r.descHtml=d,r.layout=c,r.save(function(e){e?o.send(e):o.send("success")})})}),module.exports=router;