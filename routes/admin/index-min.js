var express=require("express"),router=express.Router(),marked=require("marked"),mongoose=require("mongoose"),Project=mongoose.model("Project"),Image=mongoose.model("Image"),multer=require("multer"),upload=multer({dest:"public/uploads/"});router.get("/",function(e,o,n){Project.find(function(e,n){o.render("admin/index",{title:"Admin",projects:n})})}),router.post("/create_project",function(e,o){var n=e.body.name;console.log(n),new Project({name:n,deleted:!1}).save(function(e,n){e||o.send(n._id)})}),router.post("/create_sub_project",function(e,o){var n=e.body.name,r=e.body.parentId;Project.findById(r,function(e,t){if(e)console.log(e);else{var i=new Project({name:n,deleted:!1,hasParent:!0,parentId:r,parentName:t.name});i.save(),console.log(t),t.children.push(i._id),t.hasChildren=!0,t.save(function(e,n){o.send("success")})}})}),router.get("/delete/:id",function(e,o){var n=e.params.id;Project.findById(n,function(e,n){n.deleted=!0,n.save(function(e,n){o.redirect("/admin")})})}),router.get("/project/:id",function(e,o,n){Project.find(function(n,r){o.render("admin/index",{title:"Admin",projects:r,currentProjectId:e.params.id})})}),router.post("/save_all",function(e,o){var n=e.body,r=n.id,t=n.description,i=marked(t),s=n.layout,a="";Project.findById(r,function(e,r){r.descMU=t,r.descHtml=i,r.layout=s,n.namechanged&&(r.name=n.name,a="changed"),r.save(function(e){e?o.send(e):o.send(a)})})}),router.post("/upload",upload.single("file"),function(e,o){var n=e.file;if(console.log(n),!n.mimetype.startsWith("image/"))return o.status(422).json({error:"Die Datei muss ein Bildformat sein."});var r=e.body.project_id;Project.findById(r,function(e,r){if(e)o.send(e);else{var t=new Image({filename:n.filename,originalName:n.originalname,path:n.path,fileSize:n.size,isVisible:!0,isDeleted:!1});t.save(),r.images.push(t),r.save(function(e,n){o.send("success")})}})}),router.post("/update_image/:cat",function(e,o){var n=e.body,r=e.params.cat;console.log(r),Project.findById(n.proid,function(e,t,i){for(var s=t.images,a=0;a<s.length;a++)if(s[a]._id==n.imgid)switch(r){case"cover":s[a].isCover=!0;break;case"visible":s[a].isVisible=n.vistatus;break;case"delete":s[a].isDeleted=!0}else"cover"==r&&(s[a].isCover=!1);t.save(function(e,n){o.send("success")})})}),module.exports=router;