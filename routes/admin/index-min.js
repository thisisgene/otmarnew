var express=require("express"),router=express.Router(),marked=require("marked"),mongoose=require("mongoose"),Project=mongoose.model("Project"),Image=mongoose.model("Image"),multer=require("multer"),upload=multer({dest:"public/uploads/"});router.get("/",function(e,n,o){Project.find(function(e,o){n.render("admin/index",{title:"Admin",projects:o})})}),router.post("/create_project",function(e,n){var o=e.body.name;console.log(o),new Project({name:o,deleted:!1}).save(function(e,o){e||n.send(o._id)})}),router.post("/create_sub_project",function(e,n){var o=e.body.name,i=e.body.parentId;Project.findById(i,function(e,r){if(e)console.log(e);else{var t=new Project({name:o,deleted:!1,hasParent:!0,parentId:i,parentName:r.name});t.save(),console.log(r),r.children.push(t._id),r.hasChildren=!0,r.save(function(e,o){n.send("success")})}})}),router.get("/delete/:id",function(e,n){var o=e.params.id;Project.findById(o,function(e,o){o.deleted=!0,o.save(function(e,o){n.redirect("/admin")})})}),router.get("/project/:id",function(e,n,o){Project.find(function(o,i){n.render("admin/index",{title:"Admin",projects:i,currentProjectId:e.params.id})})}),router.post("/save_all",function(e,n){var o=e.body,i=o.id,r=o.description,t=marked(r),s=o.layout,a="";Project.findById(i,function(e,i){i.descMU=r,i.descHtml=t,i.layout=s,o.namechanged&&(i.name=o.name,a="changed"),i.save(function(e){e?n.send(e):n.send(a)})})}),router.post("/upload",upload.single("file"),function(e,n){var o=e.file;if(console.log(o),!o.mimetype.startsWith("image/"))return n.status(422).json({error:"Die Datei muss ein Bildformat sein."});var i=e.body.project_id;Project.findById(i,function(e,i){if(e)n.send(e);else{var r=new Image({filename:o.filename,originalName:o.originalname,name:o.originalname,path:o.path,fileSize:o.size,isVisible:!0,isDeleted:!1});r.save(),i.images.push(r),i.save(function(e,o){n.send("success")})}})}),router.post("/update_image/:cat",function(e,n){var o=e.body,i=e.params.cat;console.log(i),Project.findById(o.proid,function(e,r,t){for(var s=r.images,a=0;a<s.length;a++)if(s[a]._id==o.imgid)switch(i){case"cover":s[a].isCover=!0;break;case"visible":s[a].isVisible=o.vistatus;break;case"delete":s[a].isDeleted=!0}else"cover"==i&&(s[a].isCover=!1);r.save(function(e,o){n.send("success")})})}),router.post("/edit_image",function(e,n){var o=e.body;Project.findById(o.project_id,function(e,i){for(var r=i.images,t=0;t<r.length;t++)if(r[t]._id==o.image_id){var s=r[t];s.name=o.name,s.desc=o.desc}i.save(function(e,o){n.send("success")})})}),module.exports=router;