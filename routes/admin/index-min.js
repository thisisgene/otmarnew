function match_loop(e,n){for(var t=0;t<e.length;t++)if(console.log(e[t].latName,n,e[t].latName==n),e[t].latName==n)return!0;return!1}var express=require("express"),router=express.Router(),marked=require("marked"),mongoose=require("mongoose"),Project=mongoose.model("Project"),Image=mongoose.model("Image"),multer=require("multer"),upload=multer({dest:"public/uploads/"}),latinize=require("latinize");router.get("/",function(e,n,t){Project.find(function(e,t){n.render("admin/index",{title:"Admin",projects:t})})}),router.post("/create_project",function(e,n){var t=e.body.name,o=latinize(t).toLowerCase();o=o.replace(/\s/g,"_"),Project.findOne({latName:o},function(e,a){if(a){var i=Math.random().toString(36).substr(2,5);o=o+"_"+i.toString()}new Project({name:t,title:t,latName:o,deleted:!1,visible:!0,layout:"layout_mnu"}).save(function(e,t){e||n.send(t._id)})})}),router.post("/create_sub_project",function(e,n){var t=e.body.name,o=e.body.parentId,a=latinize(t).toLowerCase();a=a.replace(/\s/g,"_"),Project.findById(o,function(e,n){e?console.log(e):Project.findOne({latName:a},function(e,i){if(e&&console.log(e),i){var r=Math.random().toString(36).substr(2,5);a=a+"_"+r.toString()}var s=n.ancestors?n.ancestors:[];match_loop(s,n.latName)||s.push({name:n.name,id:n._id,latName:n.latName});var d=new Project({name:t,title:t,latName:a,deleted:!1,visible:!0,hasParent:!0,parentId:o,parentName:n.name,ancestors:s,layout:"layout_mnu"});console.log("Ancestors: ",s),d.save(),n.children.push(d),n.childrenIds.push(d._id),n.hasChildren=!0,n.save(function(e){if(e)throw e})})})}),router.get("/delete/:id",function(e,n){var t=e.params.id;Project.findById(t,function(e,t){t.hasParent&&Project.findById(t.parentId,function(e,n){console.log("parent: ",n.name);for(var o=n.children,a=0;a<o.length;a++){var i=o[a];console.log(i.name),i.id==t.id&&(i.deleted=!0)}n.children.length<=0&&(n.hasChildren=!1),n.save()}),t.deleted=!0,t.save(function(e,t){n.redirect("/admin")})})}),router.get("/project/:id",function(e,n,t){Project.find(function(t,o){n.render("admin/index",{title:"Admin",projects:o,currentProjectId:e.params.id})})}),router.post("/togglefold",function(e,n){var t=e.body;Project.findById(t.id,function(e,o){o.unfold=t.unfold,o.save(function(e){e||n.send("success")})})}),router.post("/save_all",function(e,n){var t=e.body,o=t.id,a=t.name,i=t.title,r=t.description,s=marked(r),d=t.layout,c=t.menuname,l=t.visible,u="";Project.findById(o,function(e,o){o.title=i,o.descMU=r,o.descHtml=s,o.layout=d,o.latName=c,o.visible=l,t.namechanged&&(o.name=t.name,u="changed"),o.hasParent&&Project.findById(o.parentId,function(e,n){console.log("parent: ",n.name);for(var t=n.children,u=0;u<t.length;u++){var m=t[u];console.log(m.name),m.id==o.id&&(m.name=a,m.title=i,m.descMU=r,m.descHtml=s,m.layout=d,m.latName=c,m.visible=l)}n.save()}),o.save(function(e){e?n.send(e):n.send(u)})})}),router.post("/check_name",function(e,n){var t=e.body,o=t.name,a=t.id;Project.findById(a,function(e,t){e||Project.findOne({latName:o},function(e,t){t&&t._id!=a?n.send("not_unique"):e?n.send(e):n.send("unique")})})}),router.post("/upload",upload.single("file"),function(e,n){var t=e.file;if(console.log(t),!t.mimetype.startsWith("image/"))return n.status(422).json({error:"Die Datei muss ein Bildformat sein."});var o=e.body.project_id;Project.findById(o,function(e,o){if(e)n.send(e);else{var a=new Image({filename:t.filename,originalName:t.originalname,name:t.originalname,path:t.path,fileSize:t.size,isVisible:!0,isDeleted:!1});a.save(),o.images.push(a),o.save(function(e,t){n.send("success")})}})}),router.post("/update_image/:cat",function(e,n){var t=e.body,o=e.params.cat;console.log(o),Project.findById(t.proid,function(e,a,i){for(var r=a.images,s=0;s<r.length;s++)if(r[s]._id==t.imgid)switch(o){case"cover":r[s].isCover=!0;break;case"visible":r[s].isVisible=t.vistatus;break;case"delete":r[s].isDeleted=!0}else"cover"==o&&(r[s].isCover=!1);a.save(function(e,t){n.send("success")})})}),router.post("/edit_image",function(e,n){var t=e.body;Project.findById(t.project_id,function(e,o){for(var a=o.images,i=0;i<a.length;i++)if(a[i]._id==t.image_id){var r=a[i];r.name=t.name,r.desc=t.desc}o.save(function(e,t){n.send("success")})})}),module.exports=router;